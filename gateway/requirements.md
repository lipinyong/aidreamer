# Gateway 服务需求设计文档

## 服务概述

Gateway 是平台的网关服务，作为整个微服务架构的入口，负责路由转发、权限控制、反向代理等功能。同时，Gateway 还负责为其他容器提供注册和注销服务，实现服务的动态发现和管理。

## 核心定位

- **统一入口**：所有外部请求的统一入口点
- **路由转发**：根据路由规则将请求转发到对应的微服务
- **权限控制**：统一处理认证和授权
- **反向代理**：作为反向代理服务器，转发请求到后端服务
- **服务注册中心**：管理其他微服务的注册和注销

## 技术栈

- **Web 框架**：基于 Base 服务（FastAPI）
- **部署方式**：Docker 镜像（基于 base 镜像）
- **服务发现**：支持服务注册和发现机制
- **负载均衡**：支持多实例负载均衡

## 核心功能需求

### 1. 路由转发功能

#### 1.1 路由规则配置
- **配置方式**：支持通过配置文件或管理界面配置路由规则
- **路由匹配**：支持多种路由匹配方式
  - 路径匹配（精确匹配、前缀匹配、正则匹配）
  - 域名匹配
  - 请求方法匹配（GET、POST、PUT、DELETE 等）
- **路由优先级**：支持路由规则优先级配置
- **动态路由**：支持运行时动态添加、修改、删除路由规则

#### 1.2 请求转发
- **转发策略**：
  - 支持 HTTP/HTTPS 协议转发
  - 支持 WebSocket 协议转发
  - 支持 gRPC 协议转发（可选）
- **请求处理**：
  - 请求头转发（支持自定义头信息）
  - 请求体转发（支持各种 Content-Type）
  - 查询参数转发
- **响应处理**：
  - 响应头处理
  - 响应体处理
  - 错误响应处理

#### 1.3 负载均衡
- **负载均衡算法**：
  - 轮询（Round Robin）
  - 加权轮询（Weighted Round Robin）
  - 最少连接（Least Connections）
  - IP 哈希（IP Hash）
- **健康检查**：定期检查后端服务健康状态，自动剔除不健康实例
- **故障转移**：后端服务故障时自动切换到其他可用实例

### 2. 权限控制功能

#### 2.1 认证管理
- **Token 验证**：
  - 验证请求中的 Token（支持 Header 和参数两种方式）
  - Token 格式验证（JWT、OAuth2 Token 等）
  - Token 过期检查
- **Session 管理**：
  - 与 Sessions 服务集成，验证 Session 有效性
  - 支持 Session 刷新
- **OAuth2 集成**：
  - 支持 OAuth2 认证流程
  - 支持多种 OAuth2 提供商
  - Token 交换和刷新

#### 2.2 授权管理
- **权限验证**：
  - 基于角色的访问控制（RBAC）
  - 基于资源的访问控制（ABAC）
  - API 级别的权限控制
- **权限配置**：
  - 支持通过配置文件或管理界面配置权限规则
  - 支持动态权限更新
- **权限缓存**：缓存权限信息，提高验证性能

#### 2.3 访问控制
- **IP 白名单/黑名单**：
  - 支持 IP 地址白名单
  - 支持 IP 地址黑名单
  - 支持 CIDR 格式配置
- **限流控制**：
  - 支持基于 IP 的限流
  - 支持基于用户的限流
  - 支持基于 API 的限流
  - 限流算法：令牌桶、漏桶等
- **CORS 配置**：支持跨域资源共享配置

### 3. 反向代理功能

#### 3.1 代理配置
- **后端服务配置**：
  - 支持配置多个后端服务实例
  - 支持配置后端服务地址（IP:Port 或域名）
  - 支持配置代理超时时间
- **协议支持**：
  - HTTP/HTTPS 代理
  - WebSocket 代理
  - gRPC 代理（可选）

#### 3.2 请求处理
- **请求头处理**：
  - 添加、修改、删除请求头
  - 支持 X-Forwarded-For、X-Real-IP 等标准头
- **URL 重写**：
  - 支持 URL 路径重写
  - 支持查询参数重写
- **请求体处理**：
  - 支持流式传输
  - 支持请求体大小限制

#### 3.3 响应处理
- **响应头处理**：
  - 添加、修改、删除响应头
  - 支持 CORS 头设置
- **响应体处理**：
  - 支持响应体压缩（Gzip、Brotli）
  - 支持响应体缓存
- **错误处理**：
  - 后端服务错误时的响应处理
  - 自定义错误页面

### 4. 服务注册与发现

#### 4.1 服务注册
- **注册接口**：
  - 提供 RESTful API 供其他服务注册
  - 注册信息包括：服务名称、服务地址、健康检查地址、元数据等
- **注册方式**：
  - 主动注册：服务启动时主动向 Gateway 注册
  - 被动发现：Gateway 主动扫描服务（可选）
- **注册信息**：
  - 服务标识（唯一 ID）
  - 服务名称
  - 服务地址（IP:Port 或域名）
  - 健康检查地址
  - 服务元数据（版本、标签等）
  - 服务权重（用于负载均衡）

#### 4.2 服务注销
- **注销接口**：
  - 提供 RESTful API 供其他服务注销
  - 支持优雅注销（等待正在处理的请求完成）
- **自动注销**：
  - 服务健康检查失败时自动注销
  - 服务长时间无响应时自动注销
- **注销通知**：服务注销时通知相关系统

#### 4.3 服务发现
- **服务查询**：
  - 提供 RESTful API 查询可用服务列表
  - 支持按服务名称查询
  - 支持按标签查询
- **服务状态**：
  - 实时服务状态查询
  - 服务健康状态监控
- **服务列表管理**：
  - 维护所有已注册服务的列表
  - 支持服务列表的增删改查

#### 4.4 健康检查
- **检查方式**：
  - HTTP 健康检查（GET 请求）
  - TCP 健康检查（端口连通性）
  - 自定义健康检查脚本
- **检查配置**：
  - 检查间隔时间
  - 检查超时时间
  - 失败阈值（连续失败多少次后标记为不健康）
  - 恢复阈值（连续成功多少次后标记为健康）
- **健康状态**：
  - 健康（Healthy）
  - 不健康（Unhealthy）
  - 未知（Unknown）

### 5. 监控与日志

#### 5.1 请求监控
- **请求统计**：
  - 请求总数、成功数、失败数
  - 请求响应时间统计（P50、P95、P99）
  - 请求 QPS（每秒请求数）
- **服务监控**：
  - 各后端服务的请求统计
  - 各后端服务的健康状态
  - 各后端服务的负载情况

#### 5.2 日志记录
- **访问日志**：
  - 记录所有经过 Gateway 的请求
  - 包括：请求时间、客户端 IP、请求方法、请求路径、响应状态码、响应时间等
- **错误日志**：
  - 记录所有错误信息
  - 包括：错误类型、错误消息、堆栈信息等
- **日志格式**：
  - 支持 JSON 格式
  - 支持结构化日志
  - 支持日志级别配置

#### 5.3 指标导出
- **Prometheus 集成**：支持 Prometheus 指标导出
- **指标类型**：
  - Counter：请求总数、错误总数等
  - Gauge：当前连接数、活跃服务数等
  - Histogram：请求响应时间分布等

### 6. 配置管理

#### 6.1 配置文件
- **主配置文件**：`etc/config.yaml`
- **配置内容**：
  - 服务监听地址和端口
  - 路由规则配置
  - 权限规则配置
  - 后端服务配置
  - 负载均衡配置
  - 限流配置
  - 日志配置

#### 6.2 配置热加载
- **监控配置变更**：监控配置文件变化，自动重新加载
- **配置验证**：加载配置前进行验证，确保配置正确
- **配置回滚**：配置加载失败时自动回滚到上一版本

#### 6.3 配置管理界面
- **Web 管理界面**：提供 Web 界面管理配置
- **功能**：
  - 路由规则管理
  - 权限规则管理
  - 服务注册信息管理
  - 配置导入导出

### 7. 安全功能

#### 7.1 请求安全
- **HTTPS 支持**：支持 HTTPS 协议
- **SSL/TLS 配置**：支持 SSL 证书配置
- **请求验证**：请求签名验证（可选）

#### 7.2 防护功能
- **DDoS 防护**：基础 DDoS 防护
- **SQL 注入防护**：请求参数 SQL 注入检测
- **XSS 防护**：请求参数 XSS 检测
- **CSRF 防护**：CSRF Token 验证

#### 7.3 安全审计
- **安全日志**：记录所有安全相关事件
- **异常检测**：检测异常请求模式
- **告警机制**：安全事件告警

## API 接口设计

### 服务注册 API

#### 注册服务
```
POST /api/gateway/services/register
Content-Type: application/json

{
  "service_id": "service-001",
  "service_name": "ai_node",
  "service_address": "http://ai_node:8000",
  "health_check_url": "http://ai_node:8000/health",
  "metadata": {
    "version": "1.0.0",
    "tags": ["ai", "ml"]
  },
  "weight": 100
}
```

#### 注销服务
```
DELETE /api/gateway/services/{service_id}
```

#### 更新服务
```
PUT /api/gateway/services/{service_id}
Content-Type: application/json

{
  "service_address": "http://ai_node:8001",
  "weight": 150
}
```

### 服务发现 API

#### 查询服务列表
```
GET /api/gateway/services
Query Parameters:
  - name: 服务名称（可选）
  - tag: 标签（可选）
  - status: 状态（healthy/unhealthy，可选）
```

#### 查询服务详情
```
GET /api/gateway/services/{service_id}
```

### 路由管理 API

#### 创建路由规则
```
POST /api/gateway/routes
Content-Type: application/json

{
  "name": "ai-service-route",
  "path": "/api/ai/**",
  "methods": ["GET", "POST"],
  "target_service": "ai_node",
  "priority": 100
}
```

#### 更新路由规则
```
PUT /api/gateway/routes/{route_id}
```

#### 删除路由规则
```
DELETE /api/gateway/routes/{route_id}
```

#### 查询路由列表
```
GET /api/gateway/routes
```

### 权限管理 API

#### 创建权限规则
```
POST /api/gateway/permissions
Content-Type: application/json

{
  "path": "/api/admin/**",
  "methods": ["*"],
  "required_roles": ["admin"],
  "required_permissions": ["admin:read", "admin:write"]
}
```

#### 更新权限规则
```
PUT /api/gateway/permissions/{permission_id}
```

#### 删除权限规则
```
DELETE /api/gateway/permissions/{permission_id}
```

## 目录结构

```
gateway/
├── etc/
│   └── config.yaml              # Gateway 配置文件
├── module/
│   ├── router.py                 # 路由管理模块
│   ├── proxy.py                  # 反向代理模块
│   ├── auth.py                   # 认证授权模块
│   └── registry.py               # 服务注册发现模块
├── plugin/
│   ├── rate_limit.py             # 限流插件
│   ├── cors.py                   # CORS 插件
│   └── security.py               # 安全插件
├── service/
│   ├── health_checker.py         # 健康检查服务
│   └── monitor.py                # 监控服务
└── web/
    ├── manager/                  # 管理界面
    │   ├── index.html
    │   ├── routes.html           # 路由管理页面
    │   ├── services.html         # 服务管理页面
    │   └── permissions.html      # 权限管理页面
    └── help/                      # API 文档
```

## 非功能性需求

### 性能要求
- **高并发**：支持 10000+ QPS
- **低延迟**：代理转发延迟 < 10ms（P95）
- **高可用**：服务可用性 > 99.9%

### 可靠性要求
- **故障隔离**：后端服务故障不影响 Gateway 本身
- **优雅降级**：后端服务不可用时返回友好错误信息
- **自动恢复**：后端服务恢复后自动重新路由

### 可扩展性要求
- **水平扩展**：支持多实例部署
- **插件扩展**：支持自定义插件开发
- **协议扩展**：支持新协议接入

### 安全性要求
- **数据加密**：支持 HTTPS/TLS 加密
- **访问控制**：严格的权限控制
- **安全审计**：完整的安全日志记录

## 依赖关系

### 依赖服务
- **Base 服务**：基于 base 镜像构建
- **Sessions 服务**：用于 Session 验证和管理

### 被依赖关系
- 所有其他微服务通过 Gateway 对外提供服务
- 所有外部请求通过 Gateway 访问内部服务

## 开发规范

### 代码规范
- 遵循 Base 服务的代码规范
- 使用类型提示
- 完整的文档字符串

### 测试要求
- 单元测试覆盖率 > 80%
- 集成测试覆盖主要功能
- 性能测试验证高并发场景

### 文档要求
- API 文档完整
- 部署文档详细
- 运维文档清晰
